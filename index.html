<!DOCTYPE html>
<html>
       <!-- For www.waveformer.net <script type="text/javascript" src="../common.js"></script> --> 
    <head>
        <meta charset="UTF-8">
        <title>Waveformer Circuit Bender</title>
        <!-- For www.waveformer.net <link rel="stylesheet" type="text/css" href="../common.css"/> -->
        <!-- For www.waveformer.net <link rel="stylesheet" type="text/css" href="../navbar.css"/>  -->
        <link rel="stylesheet" type="text/css" href="style.css"/>
    </head>
    <body>
        <h1>Waveformer's Circuit Bender</h1>
        <div id="content">
            <table id="settingsTable" class="center">
                <tr id="title">
                    <th colspan="4">Settings</th>
                </tr>
                <tr id="heading">
                    <th>Device</th>
                    <th>Synth 1 MIDI Channel</th>
                    <th>Synth 2 MIDI Channel</th>
                    <th>Drums MIDI Channel</th>
                </tr>
            </table>

            <div id="midiMapperTables"></div>
        </div>

        <script>

            var mappings = []; // Array of objects describing mappings 
                                // deviceId, channel, cc/NRPN -> deviceId, channel, CC/NRPN
            var mappingsEnableAll = false;
            var settings = {
                // devices: [] // enabled, inputDeviceId, synth 1 channel, synth 2 channel, drum channel
            };
            var macroControls = [ 80, 81, 82, 83, 84, 85, 86, 87 ]; // CC numbers for each (0-based index) macro
            var macroKnobs = [
                {
                    position: 80,
                    destinationA: [ 3, 0], 
                    destinationB: [ 3, 4], 
                    destinationC: [ 3, 8], 
                    destinationD: [ 3, 12], 
                },
                {
                    position: 81,
                    destinationA: [ 3, 16], 
                    destinationB: [ 3, 20], 
                    destinationC: [ 3, 24], 
                    destinationD: [ 3, 28], 
                },
                {
                    position: 82,
                    destinationA: [ 3, 32], 
                    destinationB: [ 3, 36], 
                    destinationC: [ 3, 40], 
                    destinationD: [ 3, 44], 
                },
                {
                    position: 83,
                    destinationA: [ 3, 48], 
                    destinationB: [ 3, 52], 
                    destinationC: [ 3, 56], 
                    destinationD: [ 3, 60], 
                },
                {
                    position: 84,
                    destinationA: [ 3, 64], 
                    destinationB: [ 3, 68], 
                    destinationC: [ 3, 72], 
                    destinationD: [ 3, 76], 
                },
                {
                    position: 85,
                    destinationA: [ 3, 80], 
                    destinationB: [ 3, 84], 
                    destinationC: [ 3, 88], 
                    destinationD: [ 3, 92], 
                },
                {
                    position: 86,
                    destinationA: [ 3, 96], 
                    destinationB: [ 3, 100], 
                    destinationC: [ 3, 104], 
                    destinationD: [ 3, 108], 
                },
                {
                    position: 87,
                    destinationA: [ 3, 112], 
                    destinationB: [ 3, 116], 
                    destinationC: [ 3, 120], 
                    destinationD: [ 3, 124], 
                },
            ];

            var parameters = [
                {
                    name: "Synth 1 pan",
                    type: "CC",
                    CC: 117,
                    channel: 15,
                    color: "synth1LightColor",
                    defaultMacro: 7,
                    defaultSynthControl: 1,
                },
                {
                    name: "Synth 2 pan",
                    type: "CC",
                    CC: 118,
                    channel: 15,
                    color: "synth2LightColor",
                    defaultMacro: 7,
                    defaultSynthControl: 2,
                },
                {
                    name: "Drum 1 pan",
                    type: "CC",
                    CC: 77,
                    channel: "drumChannel",
                    color: "drumLightColor",
                    defaultMacro: 6,
                    defaultSynthControl: 1,
                },
                {
                    name: "Drum 2 pan",
                    type: "CC",
                    CC: 78,
                    channel: "drumChannel",
                    color: "drumLightColor",
                    defaultMacro: 5,
                    defaultSynthControl: 1,
                },
                {
                    name: "Drum 3 pan",
                    type: "CC",
                    CC: 79,
                    channel: "drumChannel",
                    color: "drumLightColor",
                    defaultMacro: 6,
                    defaultSynthControl: 2,
                },
                {
                    name: "Drum 4 pan",
                    type: "CC",
                    CC: 80,
                    channel: "drumChannel",
                    color: "drumLightColor",
                    defaultMacro: 5,
                    defaultSynthControl: 2,
                },
                {
                    name: "Master filter resonance",
                    type: "CC",
                    CC: 71,
                    channel: 15,
                    color: "backgroundLightColor",
                    defaultMacro: 8,
                    defaultSynthControl: 1,
                },
            ];

            if (!navigator.requestMIDIAccess)
            {
                var content = document.getElementById("content");
                content.innerHTML = "Your web browser does not support the WebMIDI standard. Try using the latest version of the Chrome or Opera browsers.";
            }

            navigator.requestMIDIAccess().then(onMIDISuccess, onMIDIFailure);

            function sendNRPN(port, channel, msb, lsb, data)
            {
                sendCC(port, channel, 99, msb);
                sendCC(port, channel, 98, lsb);
                sendCC(port, channel, 6, data);
            }

            function sendCC(port, channel, controllerNumber, controllerValue)
            {
                port.send([0b10110000 + channel, controllerNumber, controllerValue]);
            }

            function onMIDISuccess(midiAccess) {
                midiAccess.addEventListener("statechange", function(event) {
                    console.log("Device updated: " + event.port.name + " [" + event.port.type + "] " + event.port.state);
                    openMIDIDevices(midiAccess);
                    initSettings(midiAccess, settings);
                    updateSettingsTable(midiAccess, settings);
                    updateMappings(midiAccess, mappings);
                    updateMIDIMapperTables(midiAccess, settings);
                });

                openMIDIDevices(midiAccess);
                initSettings(midiAccess, settings);
                updateSettingsTable(midiAccess, settings);
                updateMappings(midiAccess, mappings);
                updateMIDIMapperTables(midiAccess, settings);
            }

            function onMIDIFailure() {
                console.log("Could not access MIDI devices");
            }

            function openMIDIDevices(midiAccess)
            {
                var ports = midiAccess.inputs;
                ports.forEach(function(port, key) {
                    if (port.connection !== "open")
                    {
                        console.log("Adding event listener for port: " + port.name);
                        port.open();
                        port.onmidimessage = function(event) {
                            midiMessageReceived(midiAccess, port, event)
                        };
                    }
                });
                ports = midiAccess.outputs;
                ports.forEach(function(port, key) {
                    if (port.connection !== "open")
                        port.open();
                });
            }

            function midiMessageReceived(midiAccess, port, event)
            {
                var timestamp = event.timeStamp;
                var channel = event.data[0] & 0x0f;
                var command = event.data[0] >> 4;

                if (command == 15) // System Common or System Real-Time Messages
                    return;

                var mapping = false;
                console.log(port.id + " " + channel + " " + command + " " + event.data[1]);
                for (let i=0; i<mappings.length; i++)
                {
                    let map = mappings[i];
                    console.log(map);
                    if (map.input.deviceId == port.id && map.input.channel == channel && command == 11 && 
                        map.input.CC == event.data[1]) {
                        mapping = map;
                        break;
                    }                    
                }
                if (mapping) {
                    console.log("Found! " + mapping.output.deviceId);
                    if (mapping.enabled) {
                        var outputDevice = midiAccess.outputs.get(mapping.output.deviceId);
                        sendCC(outputDevice, mapping.output.channel, mapping.output.CC, event.data[2]);                    
                    }
                } else {
                    console.log(".");
                }
            }

            function initSettings(midiAccess, settings)
            {
                console.log("initSettings: " + settings);
                settings.devices = [];

                midiAccess.outputs.forEach(function(port, key) {
                    var matchingInputDeviceId = false;
                    midiAccess.inputs.forEach(function(inputPort, key) {
                        if (inputPort.name == port.name)
                            matchingInputDeviceId = inputPort.id;
                    });
                    if (!matchingInputDeviceId) 
                        console.log("ERROR: Could not find a MIDI input with the name '" + port.name + "''");
                    var device = {
                        enabled: port.name.match(/circuit/i),
                        inputDeviceId: matchingInputDeviceId, 
                        outputDeviceId: port.id, 
                        synth1Channel: 0,
                        synth2Channel: 1,
                        drumChannel: 9
                    };
                    settings.devices.push(device);
                });
            }

            function updateSettingsTable(midiAccess, settings)
            {
                console.log("updateSettingsTable: " + settings);
                var table = document.getElementById("settingsTable");              
                for (i=table.rows.length-1; i>=2; i--) table.deleteRow(i);

                var deviceNumber = 0;
                midiAccess.outputs.forEach(function(port, key) {
                    var deviceSettings = settings.devices[deviceNumber];

                    var row = table.insertRow(-1);
                    var c, t, l, i, s, o, d;

                    // Device name
                    c = row.insertCell(-1); c.className = "device";
                    l = document.createElement("label"); l.className = "check"; l.textContent=port.name;
                    i = document.createElement("input"); i.type = "checkbox"; 
                    i.checked = deviceSettings.enabled;
                    s = document.createElement("span"); s.className = "checkmark";
                    l.appendChild(i);
                    l.appendChild(s);
                    c.appendChild(l);

                    // Synth 1 Channel (1-15) dropdown
                    c = row.insertCell(-1); c.class = "channelSelectColumn";1
                    s = document.createElement("select"); s.id = "synth1Channel"; s.className = "channelSelect";
                    c.appendChild(s);
                    for (var i=0; i<15; i++) {
                        o = document.createElement("option");
                        o.text = i+1;
                        o.value = i;
                        s.options.add(o);
                    }
                    s.selectedIndex = deviceSettings.synth1Channel;

                    // Synth 2 Channel (1-15) dropdown
                    c = row.insertCell(-1); c.class = "channelSelectColumn";1
                    s = document.createElement("select"); s.id = "synth1Channel"; s.className = "channelSelect";
                    c.appendChild(s);
                    for (var i=0; i<15; i++) {
                        o = document.createElement("option");
                        o.text = i+1;
                        o.value = i;
                        s.options.add(o);
                    }
                    s.selectedIndex = deviceSettings.synth2Channel;

                    // Drum Channel (1-15) dropdown
                    c = row.insertCell(-1); c.class = "channelSelectColumn";1
                    s = document.createElement("select"); s.id = "synth1Channel"; s.className = "channelSelect";
                    c.appendChild(s);
                    for (var i=0; i<15; i++) {
                        o = document.createElement("option");
                        o.text = i+1;
                        o.value = i;
                        s.options.add(o);
                    }
                    s.selectedIndex = deviceSettings.drumChannel;

                    deviceNumber++;
                });
            }

            function updateMappings(midiAccess, mappings)
            {
                // device, channel, cc/NRPN -> device, channel, CC/NRPN
                mappings.length = 0;

                for (var i=0; i<settings.devices.length; i++)
                {
                    if (!settings.devices[i].enabled) {
                        continue;
                    }
                    
                    var device = settings.devices[i];

                    for (let parameter of parameters)
                    {
                        var outputChannel = parameter.channel == "drumChannel" ? device.drumChannel : parameter.channel;
                        var mapping = {
                            enabled: false,
                            input: {
                                deviceId: device.inputDeviceId,
                                channel: parameter.defaultSynthControl == 1 ? device.synth1Channel : device.synth2Channel,
                                type: "CC",
                                CC: macroControls[parameter.defaultMacro - 1],
                            },
                            output: {
                                deviceId: device.outputDeviceId,
                                channel: outputChannel,
                                type: "CC",
                                CC: parameter.CC,
                            },
                        };
                        mappings.push(mapping);
                    }
                }
                console.log(mappings);
            }

            function clearAllMacros(midiAccess, device)
            {
                console.log("Clearing macros");
                mappings.map(function(mapping) {
                    if (mapping.enabled) {
                        var macro = macroControls.findIndex(v => v == mapping.input.CC);
                        console.log("Clearing synth " + (mapping.input.channel == device.synth1Channel ? 1 : 2) + " macro " + (macro + 1));
                        var port = midiAccess.outputs.get(device.outputDeviceId);

                        sendNRPN(port, mapping.input.channel, macroKnobs[macro].destinationA[0], macroKnobs[macro].destinationA[1], 0);
                        sendNRPN(port, mapping.input.channel, macroKnobs[macro].destinationB[0], macroKnobs[macro].destinationB[1], 0);
                        sendNRPN(port, mapping.input.channel, macroKnobs[macro].destinationC[0], macroKnobs[macro].destinationC[1], 0);
                        sendNRPN(port, mapping.input.channel, macroKnobs[macro].destinationD[0], macroKnobs[macro].destinationD[1], 0);
                    }
                });
            }

            function updateMIDIMapperTables(midiAccess, settings)
            {
                var tables = document.getElementById("midiMapperTables");
                tables.innerHTML="";

                var row; 
                var c, l, s, t, i, d, d2, b, th, tr;            
                              
                for (var i=0; i<settings.devices.length; i++)
                {
                    if (!settings.devices[i].enabled) {
                        continue;
                    }

                    var device = settings.devices[i];

                    var table = document.createElement("table");
                    table.className = "midiMapperTable center";        
                    tables.appendChild(table);

                    tr = document.createElement("tr"); tr.className = "mappingTitle";
                    th = document.createElement("th"); th.colSpan = 3;
                    l = document.createElement("label"); l.className = "check"; 
                    l.textContent = "Mapping for " + midiAccess.outputs.get(device.outputDeviceId).name;
                    i = document.createElement("input"); i.type = "checkbox";
                    i.checked = mappingsEnableAll;
                    i.onchange = function(e) {
                        mappingsEnableAll = e.target.checked;
                        mappings.map(m => m.enabled = e.target.checked);
                        updateMIDIMapperTables(midiAccess, settings);
                    }; 
                    s = document.createElement("span"); s.className = "checkmark";
                    l.appendChild(i);
                    l.appendChild(s);
                    th.appendChild(l);
                    tr.appendChild(th);
                    b = document.createElement("button"); b.textContent = "Clear all Macros";
                    b.onclick = function(e) {
                        clearAllMacros(midiAccess, device);
                    };
                    tr.appendChild(b);
                    table.appendChild(tr);

                    for (let mapping of mappings)
                    {
                        console.log("X");
                        console.log(mapping);
                        if (mapping.output.deviceId != device.outputDeviceId)
                            continue;
                        console.log("Y");

                        var row = table.insertRow(-1); 

                        // Input control
                        c = row.insertCell(-1); 
                        l = document.createElement("label"); l.className = "check"; 
                        var macro = macroControls.findIndex(v => v == mapping.input.CC) + 1;
                        l.textContent = "Synth " + (mapping.input.channel == device.synth1Channel ? 1 : 2) + " Macro " + macro; 
                        i = document.createElement("input"); i.type = "checkbox"; 
                        i.checked = mapping.enabled;
                        i.onchange = function(e) {
                            console.log(e.target.checked);
                            mapping.enabled = e.target.checked;
                        }
                        s = document.createElement("span"); s.className = "checkmark";
                        c.className = mapping.input.channel == device.synth1Channel ? "synth1LightColor" : "synth2LightColor";
                        l.appendChild(i);
                        l.appendChild(s);
                        c.appendChild(l);

                        // arrow
                        c = row.insertCell(-1); 
                        c.style.textAlign = "center";
                        t = document.createTextNode("\u21FE");
                        c.appendChild(t);

                        // Output parameter
                        c = row.insertCell(-1); 
                        var parameter = parameters.find(e => e.CC == mapping.output.CC);
                        t = document.createTextNode(parameter.name);
                        c.className = parameter.color;
                        c.appendChild(t);

                        // Command = Learn
                        c = row.insertCell(-1); 
                        b = document.createElement("button"); b.textContent = "Learn";
                        c.appendChild(b);
                    }
                }
            }

        </script>

        <!-- For www.waveformer.net <script>includeHTML();</script> -->
    </body>
</html>
